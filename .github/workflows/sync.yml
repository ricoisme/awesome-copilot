name: Sync Fork
# 調度方式：每天早上 10 點
on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # Git 需要 user.name 與 user.email 才能 commit    
      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Add upstream
        run: git remote add upstream https://github.com/github/awesome-copilot.git

      - name: Fetch upstream
        run: git fetch upstream

      - name: Sync and Merge (exclude workflows)
        run: |
          # 切換到 main 分支
          git checkout main

          # 1. Merge upstream，但加上 --no-commit 讓變更停留在暫存區，不要直接提交
          # 使用 || true 避免如果完全沒有更新時報錯停止
          git merge upstream/main --no-commit --no-ff || true

          # A. 將 .github/workflows 資料夾在「暫存區」的狀態強制重置為 HEAD
          # 這會把 upstream 新增的檔案從 "要提交的名單" 中移除
          git reset HEAD .github/workflows
          
          # B. 將工作目錄中的修改還原 (恢復原本的檔案內容)
          git checkout -- .github/workflows
          
          # C. 清除未追蹤的檔案 (刪除 upstream 新增的 workflow 檔案，例如 traffic-reporting.yml)
          git clean -fd .github/workflows

          # 2. 檢查暫存區 (Staged) 是否有變更
          # git diff --cached 是檢查「暫存區」與「HEAD」的差異
          CHANGES=$(git diff --cached --name-only)
          
          if [ -n "$CHANGES" ]; then
            echo "Changes detected: $CHANGES"
            git commit -m "Sync upstream/main (excluding workflows)"
            git push origin main
          else
            echo "No changes detected (or only workflow changes were ignored)."
          fi       
